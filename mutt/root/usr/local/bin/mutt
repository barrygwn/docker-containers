#!/bin/bash
set -e

# Global variables required
APP_UID=${APP_UID:-1000}
APP_GID=${APP_GID:-1000}
APP_USER=${APP_USER:-appuser}
SETUP_ONLY=false

while [[ $# > 0 ]]; do
	key="$1"

	case $key in
		-s|--setup-only)
		SETUP_ONLY=true
		;;
		*)
				         # unknown option
		;;
	esac
	shift                # past argument or value
done

export HOME=/home/${APP_USER}
cd $HOME

# Invoke GnuPG-Agent the first time we login.
GPG_TTY=$(tty)
export GPG_TTY=$(tty)
echo " " | gpg2 -q -r ${GPGKEY} -ae | gpg2 -q

echo "Setting up mutt with secrets..."
s6-applyuidgid -u $APP_UID -g $APP_GID python /usr/lib/muttbot/muttbot.py -c /usr/lib/muttbot/revealmuttsecrets

# Start additional services
for i in $(find $HOME -name "*davmail.properties"); do
	davmail_service_name=${i%-davmail.properties}
	davmail_service_name=${davmail_service_name#$HOME/}
	echo "Setting up davmail for ${davmail_service_name}..."
	s6_davmail_dir=/var/run/s6/services/${davmail_service_name}_davmail
	s6_davmail_run=${s6_davmail_dir}/run
	mkdir -p "$s6_davmail_dir"

	cat <<-EOF > $s6_davmail_run
	#!/usr/bin/with-contenv bash

	/usr/lib/davmail/davmail.sh $i

	EOF
	chmod +x $s6_davmail_run
	s6-svscanctl -a /var/run/s6/services
	s6-svc -u $s6_davmail_dir
	sleep 5
done

if  ! $SETUP_ONLY ; then
	echo "Starting mutt..."
	s6-applyuidgid -u $APP_UID -g $APP_GID /usr/local/bin/start_mutt
fi
