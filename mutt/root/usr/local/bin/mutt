#!/bin/bash
set -e

# Global variables required
APP_UID=${APP_UID:-1000}
APP_GID=${APP_GID:-1000}
APP_USER=${APP_USER:-appuser}
SETUP_ONLY=false

export APP_USER=$APP_USER

while [[ $# > 0 ]]; do
	key="$1"

	case $key in
		-s|--setup-only)
		SETUP_ONLY=true
		;;
		*)
				         # unknown option
		;;
	esac
	shift                # past argument or value
done

export HOME=/home/${APP_USER}
cd $HOME

# Invoke GnuPG-Agent the first time we login.
GPG_TTY=$(tty)
export GPG_TTY=$(tty)
echo " " | gpg2 -q -r ${GPGKEY} -ae | gpg2 -q

echo "Setting up mutt with secrets..."
s6-applyuidgid -u $APP_UID -g $APP_GID python /usr/lib/muttbot/muttbot.py -c /usr/lib/muttbot/revealmuttsecrets

# Start additional services
for i in $(find $HOME -name "*davmail.properties"); do
	davmail_service_name=${i%-davmail.properties}
	davmail_service_name=${davmail_service_name#$HOME/}
	echo "Setting up davmail for ${davmail_service_name}..."
	s6_davmail_dir=/var/run/s6/services/${davmail_service_name}_davmail
	s6_davmail_run=${s6_davmail_dir}/run
	mkdir -p "$s6_davmail_dir"

	cat <<-EOF > $s6_davmail_run
	#!/usr/bin/with-contenv bash

	/usr/lib/davmail/davmail.sh $i

	EOF
	chmod +x $s6_davmail_run
	s6-svscanctl -a /var/run/s6/services
	s6-svc -u $s6_davmail_dir
	sleep 1
done

# do initial sync
if  ! $SETUP_ONLY ; then
	s6-applyuidgid -u $APP_UID -g $APP_GID /usr/local/bin/init_sync
fi

# Prep syncing service
sync_lock="/home/$APP_USER/.sync_lock"

if  ! $SETUP_ONLY ; then
	# init variables for background mail sync
	s6_sync_dir=/var/run/s6/services/sync
	s6_sync_run=${s6_sync_dir}/run

	mkdir -p "$s6_sync_dir"

	# create s6 service to sync mail
	cat <<-'EOF' > $s6_sync_run
	#!/usr/bin/with-contenv bash
	APP_UID=${APP_UID:-1000}
	APP_GID=${APP_GID:-1000}
	APP_USER=${APP_USER:-appuser}
	HOME=/home/$APP_USER

	sleep 30

	logfile="/home/$APP_USER/mail-sync.log"

	while true
	do
	if [ -f $logfile ]; then
		logsize=$(stat -c%s $logfile)
	else
		logsize=0
	fi
	if (($logsize > 10000000)) ; then
		[ -f $logfile.1 ] && rm -f $logfile.1 > /dev/null 2>&1
		s6-applyuidgid -u $APP_UID -g $APP_GID mv $logfile $logfile.1 > /dev/null 2>&1
	fi
	s6-applyuidgid -u $APP_UID -g $APP_GID /bin/bash -c "mail-sync >>/home/$APP_USER/mail-sync.log 2>&1"
	sleep 90
	done
	EOF

	chmod +x $s6_sync_run

	echo "Starting mutt..."
	s6-svscanctl -a /var/run/s6/services
	s6-svc -u $s6_sync_dir
	cd /home/$APP_USER/Downloads
	s6-applyuidgid -u $APP_UID -g $APP_GID /usr/bin/mutt
fi


echo "Waiting for sync operations to finish..."
while [ -f $sync_lock ]
do
	sleep 2
done

if  ! $SETUP_ONLY ; then
	s6-svc -d $s6_sync_dir
fi
