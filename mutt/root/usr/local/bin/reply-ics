#!/usr/bin/env bash
# vim:set ft=sh

if [[ -f ~/.mutt/temp/caldata ]]; then
  caldata="~/.mutt/temp/caldata"
else
  exit 0
fi

if [[ -f ~/.active_acc ]]; then
  source ~/.active_acc
else
  exit 0
fi

# get current address
email=$(cat ~/.mutt/$active_account | sed -n "s/^set\sfrom\s=\s\(.*\)/\1/p")

echo "Reply to calendar invite? [accept]/decline/tentatively :" >&2
read answer

answer=$(sed -e "s/^\(\w\).*/\1/" <<< ${answer})

ans=a
case $answer in
  a|A)
    ans=a;;
  d|D)
    ans=d;;
  t|T)
    ans=t;;
esac

# if accepted and gcalcli setup add to calendar
if [[ "$ans" == "a" || "$ans" == "t" ]] && [[ -f "~/.gcalcli_auth.json" ]]; then
  gcalcli --calendar $email --import $caldata > /dev/null 2>&1
fi

/usr/local/bin/mutt-ical.py -e $email -$ans $caldata > /dev/null 2>&1
rm $caldata > /dev/null 2>&1
printf "push <return>"
