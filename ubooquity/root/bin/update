#!/bin/bash

CURRENT_VERSION=$(cat /ubooquity.version)
UPSTREAM_VERSION=$(curl -k http://vaemendis.net/ubooquity/feed/rss | grep -o "<title>.*</title>" | sed -e s%"<title>\(\w\+\s\([0-9]*\.\?[0-9]*\.\?[0-9]*\.\?[0-9]*\)\).*"%"Ubooquity-\2.zip"%  -e 'tx' -e 'd' -e ':x' | head -1 )
if [ "$CURRENT_VERSION" != "$UPSTREAM_VERSION" ]; then
  echo "Stopping ${APP_NAME}..."
  s6-svc -d /var/run/s6/services/ubooquity > /dev/null 2>&1
  echo "Updating ${APP_NAME}..."
  curl -kL http://vaemendis.net/ubooquity/downloads/$UPSTREAM_VERSION -o /tmp/$UPSTREAM_VERSION
  rm -rf /opt/ubooquity
  mkdir -p /opt/ubooquity
  unzip /tmp/$UPSTREAM_VERSION -d /opt/ubooquity
  echo $UPSTREAM_VERSION > /ubooquity.version
  rm -rf /var/tmp
  echo "Starting ${APP_NAME}..."
  s6-svc -u /var/run/s6/services/ubooquity > /dev/null 2>&1
else
  echo "No update required."
fi
